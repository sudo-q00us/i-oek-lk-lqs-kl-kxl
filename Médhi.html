<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Application de suivi de m√©dicaments avec OCR et notifications">
    <meta name="theme-color" content="#0ea5e9">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MediSuivi">

    <title>MediSuivi - Votre Assistant Sant√©</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">

    <!-- Icons pour iOS -->
    <link rel="apple-touch-icon" href="./icon-192.png">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animation pour le scan */
        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }
        .scanner-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 2px;
            background: #3b82f6;
            box-shadow: 0 0 4px #3b82f6;
            animation: scan 2s linear infinite;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        medical: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-slate-900 dark:text-gray-100 transition-colors duration-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Composants d'ic√¥nes SVG
        const Camera = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        );
        const Pill = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.5 12.75l6 6 9-13.5" /></svg>
        );
        const Calendar = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="16" y1="2" x2="16" y2="6" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="8" y1="2" x2="8" y2="6" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="3" y1="10" x2="21" y2="10" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const Activity = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const Settings = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><path d="M12 1v6m0 6v10M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h10M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const Plus = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="5" y1="12" x2="19" y2="12" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const Check = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const X = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="6" y1="6" x2="18" y2="18" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const AlertTriangle = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="12" y1="9" x2="12" y2="13" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="12" y1="17" x2="12.01" y2="17" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const User = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><circle cx="12" cy="7" r="4" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const Phone = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const Share2 = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="18" cy="5" r="3" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><circle cx="6" cy="12" r="3" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><circle cx="18" cy="19" r="3" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const Sun = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="12" y1="1" x2="12" y2="3" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="12" y1="21" x2="12" y2="23" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="1" y1="12" x2="3" y2="12" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="21" y1="12" x2="23" y2="12" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const Moon = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const LogOut = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><polyline points="16 17 21 12 16 7" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="21" y1="12" x2="9" y2="12" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const ChevronRight = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const Clock = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><polyline points="12 6 12 12 16 14" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const FileText = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><polyline points="14 2 14 8 20 8" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="16" y1="13" x2="8" y2="13" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="16" y1="17" x2="8" y2="17" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><polyline points="10 9 9 9 8 9" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const Trash2 = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="10" y1="11" x2="10" y2="17" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="14" y1="11" x2="14" y2="17" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const Download = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><polyline points="7 10 12 15 17 10" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="12" y1="15" x2="12" y2="3" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );
        const Upload = ({size=24, className=""}) => (
            <svg width={size} height={size} className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><polyline points="17 8 12 3 7 8" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/><line x1="12" y1="3" x2="12" y2="15" strokeLinecap="round" strokeLinejoin="round" strokeWidth={2}/></svg>
        );

        // Pas de donn√©es initiales - Tout sera cr√©√© par l'utilisateur

        // --- Composants UI G√©n√©riques ---

        const Button = ({ children, onClick, variant = "primary", className = "", ...props }) => {
            const baseStyle = "px-4 py-2 rounded-xl font-medium transition-all active:scale-95 flex items-center justify-center gap-2";
            const variants = {
                primary: "bg-medical-500 hover:bg-medical-600 text-white shadow-lg shadow-medical-500/30",
                secondary: "bg-white dark:bg-slate-800 text-gray-700 dark:text-gray-200 border border-gray-200 dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700",
                danger: "bg-red-500 text-white hover:bg-red-600",
                ghost: "text-gray-500 hover:bg-gray-100 dark:hover:bg-slate-800 dark:text-gray-400"
            };
            return (
                <button onClick={onClick} className={`${baseStyle} ${variants[variant]} ${className}`} {...props}>
                    {children}
                </button>
            );
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white dark:bg-slate-800 rounded-2xl p-5 shadow-sm border border-gray-100 dark:border-slate-700 ${className}`}>
                {children}
            </div>
        );

        const Input = ({ label, ...props }) => (
            <div className="flex flex-col gap-1 mb-3">
                {label && <label className="text-sm font-medium text-gray-600 dark:text-gray-400">{label}</label>}
                <input 
                    className="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 focus:outline-none focus:ring-2 focus:ring-medical-500 transition-all dark:text-white"
                    {...props}
                />
            </div>
        );

        // --- √âcran de Bienvenue / Inscription ---
        const WelcomeScreen = ({ onComplete }) => {
            const [step, setStep] = useState('welcome'); // welcome, signup
            const [formData, setFormData] = useState({
                name: '',
                email: '',
                phone: '',
                pin: '',
                confirmPin: ''
            });
            const [error, setError] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');

                // Validations
                if (!formData.name || formData.name.length < 2) {
                    setError('Le nom doit contenir au moins 2 caract√®res');
                    return;
                }

                if (formData.pin.length !== 4 || !/^\d{4}$/.test(formData.pin)) {
                    setError('Le code PIN doit contenir 4 chiffres');
                    return;
                }

                if (formData.pin !== formData.confirmPin) {
                    setError('Les codes PIN ne correspondent pas');
                    return;
                }

                // Cr√©er le profil utilisateur
                const userProfile = {
                    name: formData.name,
                    email: formData.email,
                    phone: formData.phone,
                    pin: formData.pin,
                    createdAt: new Date().toISOString()
                };

                // Sauvegarder dans localStorage
                localStorage.setItem('medisuivi_user', JSON.stringify(userProfile));
                localStorage.setItem('medisuivi_medications', JSON.stringify([]));
                localStorage.setItem('medisuivi_contacts', JSON.stringify([]));

                onComplete(userProfile);
            };

            if (step === 'welcome') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-medical-500 to-medical-600 flex flex-col items-center justify-center p-6 text-white">
                        <div className="text-center mb-12 animate-fade-in">
                            <div className="bg-white/20 backdrop-blur-lg p-8 rounded-full inline-block mb-6 shadow-2xl">
                                <Activity size={80} className="text-white" />
                            </div>
                            <h1 className="text-4xl font-bold mb-3">Bienvenue sur MediSuivi</h1>
                            <p className="text-medical-100 text-lg max-w-md">
                                Votre assistant personnel pour ne jamais oublier vos m√©dicaments
                            </p>
                        </div>

                        <div className="w-full max-w-sm space-y-4">
                            <div className="bg-white/10 backdrop-blur-md rounded-2xl p-4 flex items-start gap-3">
                                <div className="bg-white/20 p-2 rounded-lg">
                                    <Check size={20} />
                                </div>
                                <div>
                                    <h3 className="font-semibold mb-1">Scanner intelligent OCR</h3>
                                    <p className="text-sm text-medical-100">Scannez vos ordonnances automatiquement</p>
                                </div>
                            </div>

                            <div className="bg-white/10 backdrop-blur-md rounded-2xl p-4 flex items-start gap-3">
                                <div className="bg-white/20 p-2 rounded-lg">
                                    <Check size={20} />
                                </div>
                                <div>
                                    <h3 className="font-semibold mb-1">Notifications personnalis√©es</h3>
                                    <p className="text-sm text-medical-100">Rappels avant chaque prise</p>
                                </div>
                            </div>

                            <div className="bg-white/10 backdrop-blur-md rounded-2xl p-4 flex items-start gap-3">
                                <div className="bg-white/20 p-2 rounded-lg">
                                    <Check size={20} />
                                </div>
                                <div>
                                    <h3 className="font-semibold mb-1">Donn√©es 100% locales</h3>
                                    <p className="text-sm text-medical-100">Vos informations restent sur votre appareil</p>
                                </div>
                            </div>
                        </div>

                        <button
                            onClick={() => setStep('signup')}
                            className="mt-12 w-full max-w-sm bg-white text-medical-600 hover:bg-medical-50 active:bg-white shadow-2xl text-lg py-4 px-6 rounded-xl font-medium transition-all"
                        >
                            Cr√©er mon compte
                        </button>

                        <p className="mt-6 text-medical-100 text-sm">Gratuit ‚Ä¢ Sans publicit√© ‚Ä¢ S√©curis√©</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 dark:bg-slate-900 p-6 flex flex-col">
                    <div className="flex items-center gap-2 mb-8">
                        <button onClick={() => setStep('welcome')} className="p-2 hover:bg-gray-100 rounded-full dark:hover:bg-slate-700">
                            <X size={20} />
                        </button>
                        <h2 className="text-xl font-bold dark:text-white">Cr√©er votre compte</h2>
                    </div>

                    <Card className="flex-1">
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="text-center mb-6">
                                <div className="bg-medical-100 dark:bg-medical-900/30 p-4 rounded-full inline-block mb-3">
                                    <User size={40} className="text-medical-600" />
                                </div>
                                <p className="text-gray-600 dark:text-gray-400 text-sm">
                                    Cr√©ez votre profil pour commencer
                                </p>
                            </div>

                            {error && (
                                <div className="p-3 bg-red-50 dark:bg-red-900/20 rounded-lg text-red-600 dark:text-red-400 text-sm flex items-center gap-2">
                                    <AlertTriangle size={16} />
                                    {error}
                                </div>
                            )}

                            <Input
                                label="Nom complet *"
                                placeholder="Ex: Jean Dupont"
                                value={formData.name}
                                onChange={e => setFormData({...formData, name: e.target.value})}
                                required
                            />

                            <Input
                                label="Email (optionnel)"
                                type="email"
                                placeholder="votre@email.com"
                                value={formData.email}
                                onChange={e => setFormData({...formData, email: e.target.value})}
                            />

                            <Input
                                label="T√©l√©phone (optionnel)"
                                type="tel"
                                placeholder="06 12 34 56 78"
                                value={formData.phone}
                                onChange={e => setFormData({...formData, phone: e.target.value})}
                            />

                            <div className="border-t border-gray-200 dark:border-slate-700 pt-4 mt-6">
                                <h3 className="font-semibold text-gray-700 dark:text-gray-200 mb-3 flex items-center gap-2">
                                    üîí Code PIN de s√©curit√©
                                </h3>
                                <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
                                    Ce code prot√©gera l'acc√®s √† vos donn√©es m√©dicales
                                </p>

                                <div className="grid grid-cols-2 gap-4">
                                    <Input
                                        label="Code PIN (4 chiffres) *"
                                        type="password"
                                        inputMode="numeric"
                                        maxLength={4}
                                        placeholder="****"
                                        value={formData.pin}
                                        onChange={e => setFormData({...formData, pin: e.target.value.replace(/\D/g, '')})}
                                        required
                                    />

                                    <Input
                                        label="Confirmer PIN *"
                                        type="password"
                                        inputMode="numeric"
                                        maxLength={4}
                                        placeholder="****"
                                        value={formData.confirmPin}
                                        onChange={e => setFormData({...formData, confirmPin: e.target.value.replace(/\D/g, '')})}
                                        required
                                    />
                                </div>
                            </div>

                            <Button type="submit" className="w-full mt-6">
                                <Check size={18} />
                                Cr√©er mon compte
                            </Button>

                            <p className="text-xs text-gray-400 text-center mt-4">
                                Vos donn√©es sont stock√©es localement sur votre appareil
                            </p>
                        </form>
                    </Card>
                </div>
            );
        };

        // --- √âcran PIN (S√©curit√©) ---
        const PinScreen = ({ onUnlock, userPin }) => {
            const [pin, setPin] = useState("");
            const [error, setError] = useState(false);

            const handleNum = (num) => {
                if (pin.length < 4) {
                    const newPin = pin + num;
                    setPin(newPin);
                    if (newPin.length === 4) {
                        if (newPin === userPin) {
                            onUnlock();
                        } else {
                            setError(true);
                            setTimeout(() => {
                                setPin("");
                                setError(false);
                            }, 500);
                        }
                    }
                }
            };

            return (
                <div className="min-h-screen bg-medical-50 dark:bg-slate-900 flex flex-col items-center justify-center p-6">
                    <div className="mb-8 text-center">
                        <div className="bg-white dark:bg-slate-800 p-4 rounded-full inline-block shadow-xl mb-4">
                            <Activity size={48} className="text-medical-500" />
                        </div>
                        <h1 className="text-2xl font-bold text-gray-800 dark:text-white">MediSuivi</h1>
                        <p className="text-gray-500">Entrez votre code d'acc√®s</p>
                    </div>

                    <div className="flex gap-4 mb-8">
                        {[0, 1, 2, 3].map(i => (
                            <div key={i} className={`w-4 h-4 rounded-full transition-all duration-300 ${
                                i < pin.length 
                                    ? (error ? "bg-red-500" : "bg-medical-500") 
                                    : "bg-gray-300 dark:bg-slate-700"
                            }`} />
                        ))}
                    </div>

                    <div className="grid grid-cols-3 gap-4 w-full max-w-xs">
                        {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num => (
                            <button 
                                key={num}
                                onClick={() => handleNum(num)}
                                className="h-16 rounded-2xl bg-white dark:bg-slate-800 text-2xl font-semibold text-gray-700 dark:text-white shadow-sm hover:bg-gray-50 active:scale-95 transition-all"
                            >
                                {num}
                            </button>
                        ))}
                        <div />
                        <button 
                            onClick={() => handleNum(0)}
                            className="h-16 rounded-2xl bg-white dark:bg-slate-800 text-2xl font-semibold text-gray-700 dark:text-white shadow-sm hover:bg-gray-50 active:scale-95 transition-all"
                        >
                            0
                        </button>
                        <button
                            onClick={() => setPin(pin.slice(0, -1))}
                            className="h-16 flex items-center justify-center text-gray-500 hover:text-red-500"
                        >
                            <X size={24} />
                        </button>
                    </div>
                </div>
            );
        };

        // --- Vues de l'application ---

        // 1. Dashboard / Accueil
        const Dashboard = ({ medications, onToggleTake, user }) => {
            const today = new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
            
            // Calculer progression
            let totalDoses = 0;
            let takenDoses = 0;
            
            medications.forEach(med => {
                if (med.timeSlots[0] !== "Besoin") {
                    totalDoses += med.timeSlots.length;
                    takenDoses += Object.values(med.takenToday).filter(v => v).length;
                }
            });
            
            const progress = totalDoses === 0 ? 0 : Math.round((takenDoses / totalDoses) * 100);

            return (
                <div className="space-y-6 pb-24">
                    <header className="flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold dark:text-white">Bonjour, {user.name} üëã</h2>
                            <p className="text-gray-500 dark:text-gray-400 capitalize">{today}</p>
                        </div>
                        <div className="w-10 h-10 rounded-full bg-medical-100 dark:bg-slate-800 flex items-center justify-center text-medical-600">
                            <User size={20} />
                        </div>
                    </header>

                    {/* Carte de progression */}
                    <div className="bg-gradient-to-r from-medical-500 to-medical-600 rounded-2xl p-6 text-white shadow-lg shadow-medical-500/20">
                        <div className="flex justify-between items-end mb-4">
                            <div>
                                <p className="text-medical-100 text-sm font-medium mb-1">Observance du jour</p>
                                <h3 className="text-3xl font-bold">{progress}%</h3>
                            </div>
                            <div className="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                                <Activity size={24} />
                            </div>
                        </div>
                        <div className="w-full bg-black/20 rounded-full h-2">
                            <div 
                                className="bg-white rounded-full h-2 transition-all duration-1000 ease-out" 
                                style={{ width: `${progress}%` }}
                            />
                        </div>
                        <p className="mt-2 text-xs text-medical-100">
                            {progress === 100 ? "Parfait ! Tous les traitements sont pris." : `${totalDoses - takenDoses} doses restantes aujourd'hui.`}
                        </p>
                    </div>

                    {/* Timeline des m√©dicaments */}
                    <div>
                        <h3 className="font-semibold text-lg mb-4 dark:text-white flex items-center gap-2">
                            <Clock size={18} className="text-medical-500" />
                            √Ä prendre aujourd'hui
                        </h3>
                        
                        <div className="space-y-4">
                            {medications.length === 0 ? (
                                <div className="text-center py-10 text-gray-400">Aucun traitement en cours.</div>
                            ) : medications.flatMap(med =>
                                med.timeSlots.map((time, idx) => {
                                    const isTaken = med.takenToday[time];
                                    const isPrn = time === "Besoin"; // Pro Re Nata (au besoin)

                                    return (
                                        <div key={`${med.id}-${idx}`} className={`flex items-center gap-4 bg-white dark:bg-slate-800 p-4 rounded-xl border-l-4 shadow-sm ${isTaken ? 'border-green-500 opacity-60' : 'border-medical-500'}`}>
                                            <div className="flex-1">
                                                <div className="flex justify-between items-start">
                                                    <h4 className={`font-semibold text-gray-800 dark:text-white ${isTaken ? 'line-through' : ''}`}>{med.name}</h4>
                                                    <span className="text-xs font-bold text-medical-600 bg-medical-50 dark:bg-slate-700 dark:text-medical-400 px-2 py-1 rounded-md">
                                                        {time}
                                                    </span>
                                                </div>
                                                <p className="text-sm text-gray-500 dark:text-gray-400">{med.dosage} ‚Ä¢ {isPrn ? "Si n√©cessaire" : "R√©gulier"}</p>
                                                {med.stock <= 5 && (
                                                    <p className="text-xs text-red-500 flex items-center gap-1 mt-1">
                                                        <AlertTriangle size={12} /> Stock faible ({med.stock})
                                                    </p>
                                                )}
                                            </div>
                                            <button
                                                onClick={() => onToggleTake(med.id, time)}
                                                className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${
                                                    isTaken
                                                    ? "bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400"
                                                    : "bg-gray-100 text-gray-400 hover:bg-medical-50 hover:text-medical-600 dark:bg-slate-700"
                                                }`}
                                            >
                                                {isTaken ? <Check size={20} /> : <div className="w-4 h-4 rounded-full border-2 border-current" />}
                                            </button>
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 2. Scanner OCR
        const Scanner = ({ onSaveScan, onBack }) => {
            const [isScanning, setIsScanning] = useState(false);
            const [step, setStep] = useState('intro'); // intro, scanning, preview, review
            const [scannedData, setScannedData] = useState(null);
            const [customTimes, setCustomTimes] = useState(["08:00", "13:00", "20:00"]);
            const [progress, setProgress] = useState(0);
            const [previewImage, setPreviewImage] = useState(null);
            const [multipleMeds, setMultipleMeds] = useState([]);
            const [currentMedIndex, setCurrentMedIndex] = useState(0);
            const [notificationSettings, setNotificationSettings] = useState({
                enabled: true,
                reminderTime: 15, // 15 min avant par d√©faut
                missedAlert: true
            });

            // Pr√©traitement d'image pour am√©liorer l'OCR
            const preprocessImage = (imageFile) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');

                            // Augmenter la r√©solution pour une meilleure reconnaissance
                            const scale = 2;
                            canvas.width = img.width * scale;
                            canvas.height = img.height * scale;

                            // Appliquer un filtre pour am√©liorer le contraste
                            ctx.filter = 'contrast(1.5) brightness(1.1)';
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                            // Convertir en niveaux de gris
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const data = imageData.data;

                            for (let i = 0; i < data.length; i += 4) {
                                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                                data[i] = avg;     // Red
                                data[i + 1] = avg; // Green
                                data[i + 2] = avg; // Blue
                            }

                            ctx.putImageData(imageData, 0, 0);

                            // Sauvegarder l'image pr√©visualis√©e
                            setPreviewImage(canvas.toDataURL());

                            canvas.toBlob(resolve, 'image/png');
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(imageFile);
                });
            };

            const handleFileChange = async (e) => {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    setStep('scanning');
                    setIsScanning(true);
                    setProgress(0);

                    try {
                        // Pr√©traiter l'image
                        setProgress(10);
                        const processedImage = await preprocessImage(file);

                        setProgress(20);

                        // OCR r√©el avec Tesseract.js - Configuration am√©lior√©e
                        const result = await Tesseract.recognize(
                            processedImage,
                            'fra+eng', // Fran√ßais et anglais pour les noms commerciaux
                            {
                                logger: info => {
                                    if (info.status === 'recognizing text') {
                                        setProgress(20 + Math.round(info.progress * 70));
                                    }
                                },
                                tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                                tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz√Ä√Ç√Ñ√á√â√à√ä√ã√é√è√î√ñ√ô√õ√ú≈∏√†√¢√§√ß√©√®√™√´√Æ√Ø√¥√∂√π√ª√º√ø0123456789.,;:()/-¬∞¬µ ',
                            }
                        );

                        setProgress(90);
                        const text = result.data.text;
                        console.log('Texte extrait:', text);

                        // Analyser le texte pour extraire les informations - D√©tection multiple
                        const extractedMeds = extractMultipleMedications(text);

                        setProgress(100);
                        setIsScanning(false);

                        if (extractedMeds.length === 0) {
                            alert('Aucun m√©dicament d√©tect√©. Veuillez v√©rifier la qualit√© de l\'image.');
                            setStep('intro');
                            return;
                        }

                        setMultipleMeds(extractedMeds);
                        setCurrentMedIndex(0);
                        setStep('preview');
                        setScannedData(extractedMeds[0]);

                        // D√©finir les heures par d√©faut selon la fr√©quence
                        updateCustomTimesFromFrequency(extractedMeds[0].frequency);

                    } catch (error) {
                        console.error('Erreur OCR:', error);
                        alert('Erreur lors de la lecture de l\'ordonnance. Veuillez r√©essayer avec une image plus claire.');
                        setStep('intro');
                        setIsScanning(false);
                        setProgress(0);
                    }
                }
            };

            const updateCustomTimesFromFrequency = (freq) => {
                if (freq === "1x/jour") {
                    setCustomTimes(["08:00"]);
                } else if (freq === "2x/jour") {
                    setCustomTimes(["08:00", "20:00"]);
                } else if (freq === "3x/jour") {
                    setCustomTimes(["08:00", "13:00", "20:00"]);
                } else if (freq === "4x/jour") {
                    setCustomTimes(["08:00", "12:00", "16:00", "20:00"]);
                } else {
                    setCustomTimes(["08:00", "13:00", "20:00"]);
                }
            };

            // Fonction am√©lior√©e pour extraire plusieurs m√©dicaments
            const extractMultipleMedications = (text) => {
                console.log('Texte complet OCR:', text);

                // Mots √† exclure (ne sont pas des m√©dicaments)
                const excludedWords = [
                    'ordonnance', 'prescription', 'docteur', 'dr', 'm√©decin', 'patient',
                    'nom', 'pr√©nom', 'adresse', 'telephone', 't√©l√©phone', 'email', 'date',
                    'signature', 'cachet', 'dental', 'somare', 'john', 'secu', 'mutuelle',
                    'rue', 'avenue', 'boulevard', 'ville', 'code', 'postal', 'france',
                    'monsieur', 'madame', 'mademoiselle', 'mr', 'mme', 'mlle', 'cabinet',
                    'clinique', 'hopital', 'h√¥pital', 'centre', 'pharmacie'
                ];

                // Approche simplifi√©e : chercher uniquement les lignes avec dosage ET nom valide
                const lines = text.split('\n').filter(line => line.trim().length > 3);
                const medications = [];

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    const lowerLine = line.toLowerCase();

                    // Ignorer les lignes avec mots exclus
                    if (excludedWords.some(word => lowerLine.includes(word))) {
                        continue;
                    }

                    // Chercher SEULEMENT les lignes avec un dosage clair (mg, g, ml, etc.)
                    const dosageMatch = line.match(/(\d+\s?(?:mg|g|ml|¬µg|mcg|UI|ui))/i);

                    if (dosageMatch) {
                        // Extraire le nom (tout ce qui pr√©c√®de le dosage)
                        const namePart = line.substring(0, line.indexOf(dosageMatch[0])).trim();

                        // V√©rifier que le nom est valide (au moins 3 caract√®res, pas que des chiffres)
                        if (namePart.length >= 3 && /[a-zA-Z√Ä-√ø]{3,}/.test(namePart)) {
                            // Construire le contexte (ligne actuelle + quelques lignes suivantes)
                            let context = line;
                            for (let j = i + 1; j < Math.min(i + 3, lines.length); j++) {
                                const nextLine = lines[j].toLowerCase();
                                if (!excludedWords.some(word => nextLine.includes(word))) {
                                    context += " " + lines[j];
                                }
                            }

                            medications.push({
                                name: namePart,
                                dosage: dosageMatch[1].replace(/\s/g, ''),
                                rawContext: context
                            });

                            console.log('M√©dicament trouv√©:', namePart, dosageMatch[1]);
                        }
                    }
                }

                console.log('M√©dicaments bruts trouv√©s:', medications.length);

                // Si aucun m√©dicament trouv√© avec la m√©thode stricte, essayer l'analyse globale
                if (medications.length === 0) {
                    const globalMed = extractMedicationInfo(text);
                    if (globalMed.name !== "M√©dicament") {
                        return [globalMed];
                    }
                    return [];
                }

                // Enrichir chaque m√©dicament avec les informations extraites
                const enrichedMeds = medications.map(med => {
                    const enriched = extractMedicationInfo(med.rawContext);
                    return {
                        name: med.name,
                        dosage: med.dosage,
                        frequency: enriched.frequency,
                        duration: enriched.duration,
                        prescribedBy: enriched.prescribedBy,
                        totalStock: enriched.totalStock
                    };
                });

                // D√©dupliquer les m√©dicaments (m√™me nom)
                const uniqueMeds = [];
                const seenNames = new Set();

                for (const med of enrichedMeds) {
                    const normalizedName = med.name.toLowerCase().trim();
                    if (!seenNames.has(normalizedName)) {
                        seenNames.add(normalizedName);
                        uniqueMeds.push(med);
                    }
                }

                console.log('M√©dicaments uniques finaux:', uniqueMeds.length);
                return uniqueMeds;
            };

            // Fonction am√©lior√©e pour extraire les informations d'un m√©dicament
            const extractMedicationInfo = (text) => {
                const lowerText = text.toLowerCase();

                // Extraire le nom du m√©dicament avec patterns avanc√©s
                let name = "M√©dicament";

                // Liste des noms de m√©dicaments courants (base de donn√©es simplifi√©e)
                const commonMeds = [
                    'doliprane', 'parac√©tamol', 'ibuprof√®ne', 'aspirine', 'amoxicilline',
                    'augmentin', 'tramadol', 'codeine', 'morphine', 'levothyrox',
                    'kardegic', 'efferalgan', 'advil', 'nurofen', 'spasfon',
                    'gaviscon', 'omeprazole', 'pantoprazole', 'metformine', 'insuline'
                ];

                // Chercher un m√©dicament connu
                for (const med of commonMeds) {
                    if (lowerText.includes(med)) {
                        name = med.charAt(0).toUpperCase() + med.slice(1);
                        break;
                    }
                }

                // Si pas trouv√©, chercher des patterns
                if (name === "M√©dicament") {
                    const medRegex = /(?:m√©dicament|prescription|ordonnance|traitement)[:\s]+([a-z√©√®√™√´√†√¢√§√¥√∂√ª√º√Ø√Æ]+)/i;
                    const medMatch = text.match(medRegex);
                    if (medMatch) {
                        name = medMatch[1].charAt(0).toUpperCase() + medMatch[1].slice(1);
                    } else {
                        // Essayer de trouver un mot en majuscules (souvent le nom du m√©dicament)
                        const capsRegex = /\b([A-Z√â√à√ä√ã]{3,}[A-Z√â√à√ä√ãa-z√©√®√™√´√†√¢√§√¥√∂√ª√º√Ø√Æ]+)\b/;
                        const capsMatch = text.match(capsRegex);
                        if (capsMatch) {
                            name = capsMatch[1];
                        } else {
                            // Derni√®re tentative : premier mot significatif
                            const words = text.split(/\s+/);
                            for (const word of words) {
                                if (word.length > 4 && /^[A-Z√â√à√ä√ãa-z√©√®√™√´√†√¢√§√¥√∂√ª√º√Ø√Æ]/.test(word)) {
                                    name = word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                                    break;
                                }
                            }
                        }
                    }
                }

                // Extraire le dosage avec patterns avanc√©s
                let dosage = "500mg";
                const dosageRegex = /(\d+(?:[.,]\d+)?\s?(?:mg|g|ml|¬µg|mcg|UI|ui|mg\/ml|g\/l|%|cp|comprim√©s?|g√©lules?))/i;
                const dosageMatch = text.match(dosageRegex);
                if (dosageMatch) {
                    dosage = dosageMatch[1].replace(/\s/g, '').replace(',', '.');
                }

                // Extraire la fr√©quence avec patterns avanc√©s
                let frequency = "3x/jour";

                // Patterns num√©riques
                const freqNumRegex = /(\d+)\s*(?:fois|x|√ó)\s*(?:par|\/)\s*jour/i;
                const freqNumMatch = lowerText.match(freqNumRegex);
                if (freqNumMatch) {
                    frequency = `${freqNumMatch[1]}x/jour`;
                } else if (lowerText.includes('1 fois') || lowerText.includes('une fois') || lowerText.includes('1x')) {
                    frequency = "1x/jour";
                } else if (lowerText.includes('2 fois') || lowerText.includes('deux fois') || lowerText.includes('2x')) {
                    frequency = "2x/jour";
                } else if (lowerText.includes('3 fois') || lowerText.includes('trois fois') || lowerText.includes('3x')) {
                    frequency = "3x/jour";
                } else if (lowerText.includes('4 fois') || lowerText.includes('quatre fois') || lowerText.includes('4x')) {
                    frequency = "4x/jour";
                } else if (lowerText.includes('besoin') || lowerText.includes('n√©cessaire') || lowerText.includes('si douleur')) {
                    frequency = "Besoin";
                } else if (lowerText.includes('matin') && lowerText.includes('soir')) {
                    frequency = "2x/jour";
                } else if (lowerText.includes('matin') || lowerText.includes('soir')) {
                    frequency = "1x/jour";
                }

                // Extraire la dur√©e avec patterns avanc√©s
                let duration = "7 jours";
                const durationRegex = /(?:pendant|durant|sur)\s*(\d+\s?(?:jour|jours|semaine|semaines|mois|an|ans))/i;
                const durationMatch = text.match(durationRegex);
                if (durationMatch) {
                    duration = durationMatch[1];
                } else {
                    // Chercher uniquement des dur√©es valides (avec l'unit√© compl√®te)
                    const simpleDurationRegex = /(\d+)\s?(jour|jours|semaine|semaines|mois|an|ans)\b/i;
                    const simpleDurationMatch = text.match(simpleDurationRegex);
                    if (simpleDurationMatch) {
                        duration = simpleDurationMatch[1] + ' ' + simpleDurationMatch[2];
                    } else {
                        // Si aucune dur√©e trouv√©e, laisser vide pour que l'utilisateur remplisse
                        duration = "";
                    }
                }

                // Extraire le prescripteur avec patterns avanc√©s
                let prescribedBy = "Docteur";
                const drRegex = /(?:dr\.?|docteur|m√©decin|prof\.?|professeur)\s+([a-z√©√®√™√´√†√¢√§√¥√∂√ª√º√Ø√Æ]+(?:\s+[a-z√©√®√™√´√†√¢√§√¥√∂√ª√º√Ø√Æ]+)?)/i;
                const drMatch = text.match(drRegex);
                if (drMatch) {
                    prescribedBy = drMatch[1].trim();
                }

                // Extraire la quantit√© avec patterns avanc√©s
                let totalStock = 30;
                const qtyRegex = /(?:quantit√©|bo√Æte|boite|plaquette|flacon|tube)[:\s]*(\d+)/i;
                const qtyMatch = text.match(qtyRegex);
                if (qtyMatch) {
                    totalStock = parseInt(qtyMatch[1]);
                } else {
                    // Chercher un nombre seul qui pourrait √™tre la quantit√©
                    const standaloneNumRegex = /(?:^|\s)(\d{1,3})(?:\s|$)/;
                    const standaloneNumMatch = text.match(standaloneNumRegex);
                    if (standaloneNumMatch && parseInt(standaloneNumMatch[1]) > 5) {
                        totalStock = parseInt(standaloneNumMatch[1]);
                    }
                }

                return {
                    name,
                    dosage,
                    frequency,
                    duration,
                    prescribedBy,
                    totalStock
                };
            };

            const handleFrequencyChange = (newFreq) => {
                setScannedData({...scannedData, frequency: newFreq});

                // Mettre √† jour les heures par d√©faut selon la fr√©quence
                if (newFreq === "Besoin") {
                    setCustomTimes([]);
                } else if (newFreq === "1x/jour") {
                    setCustomTimes(["08:00"]);
                } else if (newFreq === "2x/jour") {
                    setCustomTimes(["08:00", "20:00"]);
                } else if (newFreq === "3x/jour") {
                    setCustomTimes(["08:00", "13:00", "20:00"]);
                } else if (newFreq === "4x/jour") {
                    setCustomTimes(["08:00", "12:00", "16:00", "20:00"]);
                }
            };

            const handleSave = (e) => {
                e.preventDefault();
                onSaveScan({
                    ...scannedData,
                    customTimes,
                    notificationSettings
                });

                // R√©initialiser les param√®tres de notification pour le prochain m√©dicament
                setNotificationSettings({
                    enabled: true,
                    reminderTime: 15,
                    missedAlert: true
                });

                // Retirer le m√©dicament ajout√© de la liste
                const remainingMeds = multipleMeds.filter((_, index) => index !== currentMedIndex);
                setMultipleMeds(remainingMeds);

                // Si d'autres m√©dicaments restent, retourner √† la pr√©visualisation
                if (remainingMeds.length > 0) {
                    setStep('preview');
                    setScannedData(null);
                } else {
                    // Sinon, retourner √† l'√©cran d'accueil
                    setStep('intro');
                    setScannedData(null);
                    setMultipleMeds([]);
                    setPreviewImage(null);
                }
            };

            if (step === 'scanning') {
                return (
                    <div className="flex flex-col items-center justify-center h-[60vh] relative overflow-hidden rounded-2xl bg-black">
                        <img
                            src="https://images.unsplash.com/photo-1584308666744-24d5c474f2ae?auto=format&fit=crop&q=80&w=400"
                            className="absolute inset-0 w-full h-full object-cover opacity-50"
                        />
                        <div className="scanner-line z-10"></div>
                        <p className="relative z-10 text-white font-mono mt-4 animate-pulse">Analyse de l'ordonnance...</p>

                        {/* Barre de progression */}
                        <div className="relative z-10 w-3/4 mt-6">
                            <div className="w-full bg-white/20 rounded-full h-2">
                                <div
                                    className="bg-medical-400 rounded-full h-2 transition-all duration-300"
                                    style={{ width: `${progress}%` }}
                                />
                            </div>
                            <p className="text-white/80 text-xs text-center mt-2">{progress}%</p>
                        </div>

                        <div className="absolute bottom-10 left-0 right-0 text-center text-white/80 text-sm">
                            {progress < 20 && "Pr√©traitement de l'image..."}
                            {progress >= 20 && progress < 90 && "Reconnaissance de texte OCR..."}
                            {progress >= 90 && "Analyse des m√©dicaments..."}
                        </div>
                    </div>
                );
            }

            if (step === 'preview') {
                return (
                    <div className="pb-24">
                        <div className="flex items-center gap-2 mb-6">
                            <button onClick={() => setStep('intro')} className="p-2 hover:bg-gray-100 rounded-full dark:hover:bg-slate-700">
                                <X size={20} />
                            </button>
                            <h2 className="text-xl font-bold dark:text-white">R√©sultats du scan</h2>
                        </div>

                        {/* Pr√©visualisation de l'image */}
                        {previewImage && (
                            <Card className="mb-4">
                                <p className="text-sm text-gray-500 dark:text-gray-400 mb-2">Image scann√©e :</p>
                                <img src={previewImage} alt="Preview" className="w-full rounded-lg" />
                            </Card>
                        )}

                        {/* Liste des m√©dicaments d√©tect√©s */}
                        <Card>
                            <div className="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg text-sm text-green-700 dark:text-green-300 flex gap-2 mb-4">
                                <Check size={16} className="mt-0.5" />
                                <p>{multipleMeds.length} m√©dicament{multipleMeds.length > 1 ? 's' : ''} d√©tect√©{multipleMeds.length > 1 ? 's' : ''}. Cliquez pour v√©rifier et ajouter.</p>
                            </div>

                            <div className="space-y-3">
                                {multipleMeds.map((med, index) => (
                                    <div
                                        key={index}
                                        onClick={() => {
                                            setCurrentMedIndex(index);
                                            setScannedData(med);
                                            updateCustomTimesFromFrequency(med.frequency);
                                            setStep('review');
                                        }}
                                        className="p-4 bg-gray-50 dark:bg-slate-700 rounded-xl hover:bg-gray-100 dark:hover:bg-slate-600 cursor-pointer transition-all border-2 border-transparent hover:border-medical-500"
                                    >
                                        <div className="flex justify-between items-start">
                                            <div className="flex-1">
                                                <h4 className="font-bold text-gray-800 dark:text-white">{med.name}</h4>
                                                <p className="text-sm text-gray-500 dark:text-gray-400">{med.dosage} ‚Ä¢ {med.frequency}</p>
                                                <p className="text-xs text-gray-400 mt-1">Dur√©e : {med.duration}</p>
                                            </div>
                                            <ChevronRight size={20} className="text-gray-400" />
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <Button
                                variant="secondary"
                                className="w-full mt-4"
                                onClick={() => setStep('intro')}
                            >
                                Scanner une nouvelle ordonnance
                            </Button>
                        </Card>
                    </div>
                );
            }

            if (step === 'review') {
                return (
                    <div className="pb-24">
                        <div className="flex items-center gap-2 mb-6">
                            <button onClick={() => setStep(multipleMeds.length > 0 ? 'preview' : 'intro')} className="p-2 hover:bg-gray-100 rounded-full dark:hover:bg-slate-700">
                                <X size={20} />
                            </button>
                            <h2 className="text-xl font-bold dark:text-white">V√©rification</h2>
                            {multipleMeds.length > 1 && (
                                <span className="ml-auto text-sm text-gray-500 dark:text-gray-400">
                                    {currentMedIndex + 1}/{multipleMeds.length}
                                </span>
                            )}
                        </div>

                        <Card>
                            <form onSubmit={handleSave} className="space-y-4">
                                <div className="p-3 bg-blue-50 dark:bg-slate-700/50 rounded-lg text-sm text-blue-700 dark:text-blue-300 flex gap-2">
                                    <Activity size={16} className="mt-0.5" />
                                    <p>L'OCR a d√©tect√© ces informations. Merci de v√©rifier avant de valider.</p>
                                </div>

                                <Input 
                                    label="M√©dicament" 
                                    value={scannedData.name} 
                                    onChange={e => setScannedData({...scannedData, name: e.target.value})} 
                                />
                                <div className="grid grid-cols-2 gap-4">
                                    <Input 
                                        label="Dosage" 
                                        value={scannedData.dosage} 
                                        onChange={e => setScannedData({...scannedData, dosage: e.target.value})} 
                                    />
                                    <div className="flex flex-col gap-1">
                                        <Input
                                            label="Dur√©e"
                                            placeholder="Ex: 7 jours, 2 semaines, 1 mois"
                                            value={scannedData.duration}
                                            onChange={e => setScannedData({...scannedData, duration: e.target.value})}
                                        />
                                        {!scannedData.duration && (
                                            <p className="text-xs text-amber-600 dark:text-amber-400 -mt-2">
                                                ‚ö†Ô∏è Dur√©e non d√©tect√©e - Veuillez la saisir
                                            </p>
                                        )}
                                    </div>
                                </div>
                                <div className="flex flex-col gap-1 mb-3">
                                    <label className="text-sm font-medium text-gray-600 dark:text-gray-400">Fr√©quence</label>
                                    <select
                                        className="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 focus:outline-none focus:ring-2 focus:ring-medical-500 transition-all dark:text-white"
                                        value={scannedData.frequency}
                                        onChange={e => handleFrequencyChange(e.target.value)}
                                    >
                                        <option value="1x/jour">1 fois par jour</option>
                                        <option value="2x/jour">2 fois par jour</option>
                                        <option value="3x/jour">3 fois par jour</option>
                                        <option value="4x/jour">4 fois par jour</option>
                                        <option value="Besoin">Au besoin</option>
                                    </select>
                                </div>
                                {scannedData.frequency !== "Besoin" && (
                                    <div className="flex flex-col gap-2 mb-3">
                                        <label className="text-sm font-medium text-gray-600 dark:text-gray-400">Heures de prise</label>
                                        <div className="grid grid-cols-2 gap-3">
                                            {customTimes.map((time, index) => (
                                                <input
                                                    key={index}
                                                    type="time"
                                                    value={time}
                                                    onChange={e => {
                                                        const newTimes = [...customTimes];
                                                        newTimes[index] = e.target.value;
                                                        setCustomTimes(newTimes);
                                                    }}
                                                    className="px-4 py-3 rounded-xl bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 focus:outline-none focus:ring-2 focus:ring-medical-500 transition-all dark:text-white"
                                                />
                                            ))}
                                        </div>
                                    </div>
                                )}
                                <Input 
                                    label="Prescrit par" 
                                    value={scannedData.prescribedBy} 
                                    onChange={e => setScannedData({...scannedData, prescribedBy: e.target.value})} 
                                />
                                <Input
                                    label="Quantit√© d√©livr√©e (Stock)"
                                    type="number"
                                    value={scannedData.totalStock}
                                    onChange={e => setScannedData({...scannedData, totalStock: parseInt(e.target.value)})}
                                />

                                {/* Param√®tres de notification */}
                                <div className="border-t border-gray-200 dark:border-slate-700 pt-4 mt-4">
                                    <h4 className="font-semibold text-gray-700 dark:text-gray-200 mb-3 flex items-center gap-2">
                                        üîî Notifications et rappels
                                    </h4>

                                    {/* Activer les notifications */}
                                    <div className="flex items-center justify-between mb-3 p-3 bg-gray-50 dark:bg-slate-700 rounded-lg">
                                        <div>
                                            <p className="font-medium text-gray-700 dark:text-gray-200">Activer les rappels</p>
                                            <p className="text-xs text-gray-500 dark:text-gray-400">Recevoir des notifications avant chaque prise</p>
                                        </div>
                                        <div
                                            onClick={() => setNotificationSettings({...notificationSettings, enabled: !notificationSettings.enabled})}
                                            className={`w-12 h-6 rounded-full p-1 transition-colors cursor-pointer ${notificationSettings.enabled ? 'bg-medical-500' : 'bg-gray-300'}`}
                                        >
                                            <div className={`w-4 h-4 bg-white rounded-full shadow-sm transition-transform ${notificationSettings.enabled ? 'translate-x-6' : ''}`} />
                                        </div>
                                    </div>

                                    {notificationSettings.enabled && (
                                        <>
                                            {/* Temps de rappel */}
                                            <div className="mb-3">
                                                <label className="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2 block">
                                                    Rappel avant la prise
                                                </label>
                                                <select
                                                    className="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 focus:outline-none focus:ring-2 focus:ring-medical-500 transition-all dark:text-white"
                                                    value={notificationSettings.reminderTime}
                                                    onChange={e => setNotificationSettings({...notificationSettings, reminderTime: parseInt(e.target.value)})}
                                                >
                                                    <option value={15}>15 minutes avant</option>
                                                    <option value={30}>30 minutes avant</option>
                                                    <option value={60}>1 heure avant</option>
                                                </select>
                                            </div>

                                            {/* Alerte dose manqu√©e */}
                                            <div className="flex items-center justify-between p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg">
                                                <div>
                                                    <p className="font-medium text-gray-700 dark:text-gray-200">Alerte dose manqu√©e</p>
                                                    <p className="text-xs text-gray-500 dark:text-gray-400">Notification si vous oubliez une prise</p>
                                                </div>
                                                <div
                                                    onClick={() => setNotificationSettings({...notificationSettings, missedAlert: !notificationSettings.missedAlert})}
                                                    className={`w-12 h-6 rounded-full p-1 transition-colors cursor-pointer ${notificationSettings.missedAlert ? 'bg-amber-500' : 'bg-gray-300'}`}
                                                >
                                                    <div className={`w-4 h-4 bg-white rounded-full shadow-sm transition-transform ${notificationSettings.missedAlert ? 'translate-x-6' : ''}`} />
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </div>

                                <div className="flex gap-3">
                                    <Button type="submit" className="flex-1 mt-4">
                                        <Check size={18} />
                                        Confirmer et Ajouter
                                    </Button>
                                    {multipleMeds.length > 1 && (
                                        <Button
                                            type="button"
                                            variant="secondary"
                                            className="mt-4"
                                            onClick={() => setStep('preview')}
                                        >
                                            Retour
                                        </Button>
                                    )}
                                </div>
                            </form>
                        </Card>
                    </div>
                );
            }

            return (
                <div className="pb-24">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-full dark:hover:bg-slate-700">
                            <X size={20} />
                        </button>
                        <h2 className="text-xl font-bold dark:text-white">Scanner</h2>
                    </div>

                    <div className="flex flex-col items-center justify-center h-[60vh] text-center px-6">
                        <div className="bg-medical-50 dark:bg-slate-800 p-8 rounded-full mb-6 relative group cursor-pointer overflow-hidden">
                            <Camera size={64} className="text-medical-500 relative z-10" />
                            <input
                                type="file"
                                accept="image/*"
                                capture="environment"
                                onChange={handleFileChange}
                                className="absolute inset-0 opacity-0 cursor-pointer z-20"
                            />
                            <div className="absolute inset-0 bg-medical-100 dark:bg-slate-700 scale-0 group-hover:scale-100 transition-transform rounded-full" />
                        </div>
                        <h2 className="text-2xl font-bold mb-2 dark:text-white">Scanner une ordonnance</h2>
                        <p className="text-gray-500 dark:text-gray-400 mb-8 max-w-xs">
                            Prenez en photo votre ordonnance. Notre technologie OCR extraira automatiquement le nom des m√©dicaments et les dosages.
                        </p>
                        <div className="flex gap-3 text-sm text-gray-400">
                            <span className="flex items-center gap-1"><Check size={14}/> Rapide</span>
                            <span className="flex items-center gap-1"><Check size={14}/> S√©curis√©</span>
                            <span className="flex items-center gap-1"><Check size={14}/> Automatique</span>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Gestion (Inventaire & Contacts)
        const Management = ({ medications, contacts, user, onDeleteMed, onAddManual }) => {
            const [activeTab, setActiveTab] = useState('meds');

            const shareData = () => {
                const text = `Traitement de ${user.name}:\n` + medications.map(m => `- ${m.name} (${m.dosage}): ${m.frequency}`).join('\n');
                alert("Texte copi√© dans le presse-papier :\n\n" + text);
                // En vrai prod : navigator.clipboard.writeText(text);
            };

            return (
                <div className="pb-24 space-y-6">
                    <div className="flex p-1 bg-gray-200 dark:bg-slate-800 rounded-xl">
                        <button 
                            onClick={() => setActiveTab('meds')}
                            className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all ${activeTab === 'meds' ? 'bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm' : 'text-gray-500'}`}
                        >
                            M√©dicaments
                        </button>
                        <button 
                            onClick={() => setActiveTab('contacts')}
                            className={`flex-1 py-2 text-sm font-medium rounded-lg transition-all ${activeTab === 'contacts' ? 'bg-white dark:bg-slate-700 text-gray-900 dark:text-white shadow-sm' : 'text-gray-500'}`}
                        >
                            Contacts
                        </button>
                    </div>

                    {activeTab === 'meds' ? (
                        <div className="space-y-4">
                            {medications.map(med => (
                                <Card key={med.id} className="flex justify-between items-center">
                                    <div>
                                        <h4 className="font-bold text-gray-800 dark:text-white">{med.name} <span className="text-sm font-normal text-gray-500">({med.dosage})</span></h4>
                                        <div className="flex items-center gap-4 mt-2">
                                            <div className="text-xs bg-gray-100 dark:bg-slate-700 px-2 py-1 rounded text-gray-600 dark:text-gray-300">
                                                Stock: <span className={med.stock < 5 ? "text-red-500 font-bold" : ""}>{med.stock}</span> / {med.totalStock}
                                            </div>
                                            <span className="text-xs text-gray-400">Dr. {med.prescribedBy}</span>
                                        </div>
                                    </div>
                                    <button onClick={() => onDeleteMed(med.id)} className="text-gray-400 hover:text-red-500 p-2">
                                        <Trash2 size={18} />
                                    </button>
                                </Card>
                            ))}
                            <Button variant="secondary" className="w-full border-dashed" onClick={onAddManual}>
                                <Plus size={18} /> Ajouter manuellement
                            </Button>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            <div className="flex justify-between items-center mb-2">
                                <h3 className="font-semibold dark:text-white">Urgences & M√©decins</h3>
                                <button onClick={shareData} className="text-medical-500 text-sm flex items-center gap-1">
                                    <Share2 size={14} /> Partager liste
                                </button>
                            </div>
                            {contacts.map(contact => (
                                <Card key={contact.id} className="flex justify-between items-center py-4">
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400">
                                            <User size={20} />
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-gray-800 dark:text-white">{contact.name}</h4>
                                            <p className="text-sm text-gray-500">{contact.phone}</p>
                                        </div>
                                    </div>
                                    <a href={`tel:${contact.phone}`} className="p-3 bg-green-500 text-white rounded-full shadow-lg hover:bg-green-600">
                                        <Phone size={18} />
                                    </a>
                                </Card>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // 3.5. Formulaire d'ajout manuel
        const ManualAdd = ({ onSave, onBack }) => {
            const [formData, setFormData] = useState({
                name: "",
                dosage: "",
                frequency: "3x/jour",
                duration: "",
                prescribedBy: "",
                totalStock: 0
            });
            const [customTimes, setCustomTimes] = useState(["08:00", "13:00", "20:00"]);
            const [notificationSettings, setNotificationSettings] = useState({
                enabled: true,
                reminderTime: 15,
                missedAlert: true
            });

            const handleFrequencyChange = (newFreq) => {
                setFormData({...formData, frequency: newFreq});

                // Mettre √† jour les heures par d√©faut selon la fr√©quence
                if (newFreq === "Besoin") {
                    setCustomTimes([]);
                } else if (newFreq === "1x/jour") {
                    setCustomTimes(["08:00"]);
                } else if (newFreq === "2x/jour") {
                    setCustomTimes(["08:00", "20:00"]);
                } else if (newFreq === "3x/jour") {
                    setCustomTimes(["08:00", "13:00", "20:00"]);
                } else if (newFreq === "4x/jour") {
                    setCustomTimes(["08:00", "12:00", "16:00", "20:00"]);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (formData.name && formData.dosage && formData.totalStock > 0) {
                    onSave({...formData, customTimes, notificationSettings});
                }
            };

            return (
                <div className="pb-24">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={onBack} className="p-2 hover:bg-gray-100 rounded-full dark:hover:bg-slate-700">
                            <X size={20} />
                        </button>
                        <h2 className="text-xl font-bold dark:text-white">Ajouter un m√©dicament</h2>
                    </div>

                    <Card>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <Input
                                label="Nom du m√©dicament"
                                value={formData.name}
                                onChange={e => setFormData({...formData, name: e.target.value})}
                                required
                            />
                            <div className="grid grid-cols-2 gap-4">
                                <Input
                                    label="Dosage"
                                    placeholder="Ex: 500mg"
                                    value={formData.dosage}
                                    onChange={e => setFormData({...formData, dosage: e.target.value})}
                                    required
                                />
                                <Input
                                    label="Dur√©e"
                                    placeholder="Ex: 7 jours"
                                    value={formData.duration}
                                    onChange={e => setFormData({...formData, duration: e.target.value})}
                                    required
                                />
                            </div>
                            <div className="flex flex-col gap-1 mb-3">
                                <label className="text-sm font-medium text-gray-600 dark:text-gray-400">Fr√©quence</label>
                                <select
                                    className="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 focus:outline-none focus:ring-2 focus:ring-medical-500 transition-all dark:text-white"
                                    value={formData.frequency}
                                    onChange={e => handleFrequencyChange(e.target.value)}
                                >
                                    <option value="1x/jour">1 fois par jour</option>
                                    <option value="2x/jour">2 fois par jour</option>
                                    <option value="3x/jour">3 fois par jour</option>
                                    <option value="4x/jour">4 fois par jour</option>
                                    <option value="Besoin">Au besoin</option>
                                </select>
                            </div>
                            {formData.frequency !== "Besoin" && (
                                <div className="flex flex-col gap-2 mb-3">
                                    <label className="text-sm font-medium text-gray-600 dark:text-gray-400">Heures de prise</label>
                                    <div className="grid grid-cols-2 gap-3">
                                        {customTimes.map((time, index) => (
                                            <input
                                                key={index}
                                                type="time"
                                                value={time}
                                                onChange={e => {
                                                    const newTimes = [...customTimes];
                                                    newTimes[index] = e.target.value;
                                                    setCustomTimes(newTimes);
                                                }}
                                                className="px-4 py-3 rounded-xl bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 focus:outline-none focus:ring-2 focus:ring-medical-500 transition-all dark:text-white"
                                            />
                                        ))}
                                    </div>
                                </div>
                            )}
                            <Input
                                label="Prescrit par"
                                placeholder="Ex: Dr. Dupont"
                                value={formData.prescribedBy}
                                onChange={e => setFormData({...formData, prescribedBy: e.target.value})}
                                required
                            />
                            <Input
                                label="Quantit√© (Stock)"
                                type="number"
                                min="1"
                                value={formData.totalStock}
                                onChange={e => setFormData({...formData, totalStock: parseInt(e.target.value) || 0})}
                                required
                            />

                            {/* Param√®tres de notification */}
                            <div className="border-t border-gray-200 dark:border-slate-700 pt-4 mt-4">
                                <h4 className="font-semibold text-gray-700 dark:text-gray-200 mb-3 flex items-center gap-2">
                                    üîî Notifications et rappels
                                </h4>

                                {/* Activer les notifications */}
                                <div className="flex items-center justify-between mb-3 p-3 bg-gray-50 dark:bg-slate-700 rounded-lg">
                                    <div>
                                        <p className="font-medium text-gray-700 dark:text-gray-200">Activer les rappels</p>
                                        <p className="text-xs text-gray-500 dark:text-gray-400">Recevoir des notifications avant chaque prise</p>
                                    </div>
                                    <div
                                        onClick={() => setNotificationSettings({...notificationSettings, enabled: !notificationSettings.enabled})}
                                        className={`w-12 h-6 rounded-full p-1 transition-colors cursor-pointer ${notificationSettings.enabled ? 'bg-medical-500' : 'bg-gray-300'}`}
                                    >
                                        <div className={`w-4 h-4 bg-white rounded-full shadow-sm transition-transform ${notificationSettings.enabled ? 'translate-x-6' : ''}`} />
                                    </div>
                                </div>

                                {notificationSettings.enabled && (
                                    <>
                                        {/* Temps de rappel */}
                                        <div className="mb-3">
                                            <label className="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2 block">
                                                Rappel avant la prise
                                            </label>
                                            <select
                                                className="w-full px-4 py-3 rounded-xl bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 focus:outline-none focus:ring-2 focus:ring-medical-500 transition-all dark:text-white"
                                                value={notificationSettings.reminderTime}
                                                onChange={e => setNotificationSettings({...notificationSettings, reminderTime: parseInt(e.target.value)})}
                                            >
                                                <option value={15}>15 minutes avant</option>
                                                <option value={30}>30 minutes avant</option>
                                                <option value={60}>1 heure avant</option>
                                            </select>
                                        </div>

                                        {/* Alerte dose manqu√©e */}
                                        <div className="flex items-center justify-between p-3 bg-amber-50 dark:bg-amber-900/20 rounded-lg">
                                            <div>
                                                <p className="font-medium text-gray-700 dark:text-gray-200">Alerte dose manqu√©e</p>
                                                <p className="text-xs text-gray-500 dark:text-gray-400">Notification si vous oubliez une prise</p>
                                            </div>
                                            <div
                                                onClick={() => setNotificationSettings({...notificationSettings, missedAlert: !notificationSettings.missedAlert})}
                                                className={`w-12 h-6 rounded-full p-1 transition-colors cursor-pointer ${notificationSettings.missedAlert ? 'bg-amber-500' : 'bg-gray-300'}`}
                                            >
                                                <div className={`w-4 h-4 bg-white rounded-full shadow-sm transition-transform ${notificationSettings.missedAlert ? 'translate-x-6' : ''}`} />
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>

                            <Button type="submit" className="w-full mt-4">Ajouter le m√©dicament</Button>
                        </form>
                    </Card>
                </div>
            );
        };

        // 4. Param√®tres
        const SettingsView = ({ darkMode, toggleDarkMode, user, onLogout, onResetApp, medications, contacts }) => {
            // Calculer les statistiques de persistance
            const getPersistenceStats = () => {
                const medsData = localStorage.getItem('medisuivi_medications');
                const contactsData = localStorage.getItem('medisuivi_contacts');
                const userData = localStorage.getItem('medisuivi_user');

                const totalSize = ((medsData?.length || 0) + (contactsData?.length || 0) + (userData?.length || 0)) / 1024;
                const lastSave = localStorage.getItem('medisuivi_last_save') || new Date().toISOString();

                return {
                    medicationsCount: medications.length,
                    contactsCount: contacts.length,
                    storageSize: totalSize.toFixed(2),
                    lastSave: new Date(lastSave).toLocaleString('fr-FR')
                };
            };

            const stats = getPersistenceStats();

            // Fonction d'export
            const handleExport = () => {
                const data = {
                    user: JSON.parse(localStorage.getItem('medisuivi_user')),
                    medications: JSON.parse(localStorage.getItem('medisuivi_medications') || '[]'),
                    contacts: JSON.parse(localStorage.getItem('medisuivi_contacts') || '[]'),
                    exportDate: new Date().toISOString(),
                    version: '1.0.0'
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `medisuivi-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                new Notification('MediSuivi', {
                    body: 'Vos donn√©es ont √©t√© export√©es avec succ√®s !',
                    icon: 'üíæ'
                });
            };

            // Fonction d'import
            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);

                        if (confirm('‚ö†Ô∏è L\'import va remplacer toutes vos donn√©es actuelles. Continuer ?')) {
                            if (data.user) localStorage.setItem('medisuivi_user', JSON.stringify(data.user));
                            if (data.medications) localStorage.setItem('medisuivi_medications', JSON.stringify(data.medications));
                            if (data.contacts) localStorage.setItem('medisuivi_contacts', JSON.stringify(data.contacts));
                            localStorage.setItem('medisuivi_last_save', new Date().toISOString());

                            new Notification('MediSuivi', {
                                body: 'Vos donn√©es ont √©t√© import√©es avec succ√®s ! Rechargez l\'application.',
                                icon: 'üì•'
                            });

                            setTimeout(() => window.location.reload(), 2000);
                        }
                    } catch (error) {
                        alert('‚ùå Erreur lors de l\'import. Fichier invalide.');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            };

            return (
            <div className="pb-24 space-y-6">
                <div className="flex items-center gap-4 mb-8">
                    <div className="w-20 h-20 rounded-full bg-medical-200 dark:bg-slate-700 flex items-center justify-center text-4xl">
                        üè•
                    </div>
                    <div>
                        <h2 className="text-xl font-bold dark:text-white">{user.name}</h2>
                        <p className="text-gray-500">Patient</p>
                    </div>
                </div>

                <div className="space-y-2">
                    <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wider ml-1">Apparence</h3>
                    <Card className="flex justify-between items-center cursor-pointer" onClick={toggleDarkMode}>
                        <div className="flex items-center gap-3">
                            {darkMode ? <Moon size={20} /> : <Sun size={20} />}
                            <span className="dark:text-white">Mode Sombre</span>
                        </div>
                        <div className={`w-12 h-6 rounded-full p-1 transition-colors ${darkMode ? 'bg-medical-500' : 'bg-gray-300'}`}>
                            <div className={`w-4 h-4 bg-white rounded-full shadow-sm transition-transform ${darkMode ? 'translate-x-6' : ''}`} />
                        </div>
                    </Card>
                </div>

                <div className="space-y-2">
                    <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wider ml-1">Donn√©es</h3>

                    {/* Indicateur de persistance */}
                    <Card className="p-4">
                        <div className="flex items-center gap-2 mb-3">
                            <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            <span className="text-sm font-semibold dark:text-white">√âtat de sauvegarde</span>
                        </div>
                        <div className="space-y-2 text-xs">
                            <div className="flex justify-between">
                                <span className="text-gray-600 dark:text-gray-400">M√©dicaments</span>
                                <span className="font-medium dark:text-white">{stats.medicationsCount}</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-600 dark:text-gray-400">Contacts</span>
                                <span className="font-medium dark:text-white">{stats.contactsCount}</span>
                            </div>
                            <div className="flex justify-between">
                                <span className="text-gray-600 dark:text-gray-400">Taille stockage</span>
                                <span className="font-medium dark:text-white">{stats.storageSize} Ko</span>
                            </div>
                            <div className="flex justify-between pt-2 border-t border-gray-200 dark:border-slate-700">
                                <span className="text-gray-600 dark:text-gray-400">Derni√®re sauvegarde</span>
                                <span className="font-medium dark:text-white text-xs">{stats.lastSave}</span>
                            </div>
                        </div>
                    </Card>

                    {/* Export */}
                    <Card className="flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700" onClick={handleExport}>
                        <div className="flex items-center gap-3 text-gray-700 dark:text-gray-200">
                            <Download size={20} />
                            <span>Exporter mes donn√©es</span>
                        </div>
                        <ChevronRight size={18} className="text-gray-400" />
                    </Card>

                    {/* Import */}
                    <Card className="flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700">
                        <label className="flex items-center gap-3 text-gray-700 dark:text-gray-200 cursor-pointer w-full">
                            <Upload size={20} />
                            <span>Importer des donn√©es</span>
                            <input type="file" accept=".json" onChange={handleImport} className="hidden" />
                        </label>
                        <ChevronRight size={18} className="text-gray-400" />
                    </Card>

                    <Card className="flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-700">
                        <div className="flex items-center gap-3 text-gray-700 dark:text-gray-200">
                            <FileText size={20} />
                            <span>Historique archiv√©</span>
                        </div>
                        <ChevronRight size={18} className="text-gray-400" />
                    </Card>
                </div>

                <div className="space-y-2">
                    <h3 className="text-sm font-semibold text-gray-500 uppercase tracking-wider ml-1">Compte</h3>
                    <Card className="p-4">
                        <div className="space-y-2 text-sm">
                            <div className="flex justify-between">
                                <span className="text-gray-600 dark:text-gray-400">Nom</span>
                                <span className="font-medium dark:text-white">{user.name}</span>
                            </div>
                            {user.email && (
                                <div className="flex justify-between">
                                    <span className="text-gray-600 dark:text-gray-400">Email</span>
                                    <span className="font-medium dark:text-white">{user.email}</span>
                                </div>
                            )}
                            {user.phone && (
                                <div className="flex justify-between">
                                    <span className="text-gray-600 dark:text-gray-400">T√©l√©phone</span>
                                    <span className="font-medium dark:text-white">{user.phone}</span>
                                </div>
                            )}
                            <div className="flex justify-between pt-2 border-t border-gray-200 dark:border-slate-700">
                                <span className="text-gray-600 dark:text-gray-400">Compte cr√©√© le</span>
                                <span className="font-medium dark:text-white">
                                    {new Date(user.createdAt).toLocaleDateString('fr-FR')}
                                </span>
                            </div>
                        </div>
                    </Card>
                </div>

                <Button variant="danger" className="w-full mt-8" onClick={onLogout}>
                    <LogOut size={18} /> Se d√©connecter
                </Button>

                <Button
                    variant="ghost"
                    className="w-full border border-red-200 dark:border-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20"
                    onClick={onResetApp}
                >
                    <AlertTriangle size={18} /> R√©initialiser l'application
                </Button>

                <p className="text-center text-xs text-gray-400 mt-4">Version 1.0.0 ‚Ä¢ Donn√©es locales s√©curis√©es</p>
            </div>
            );
        };

        // --- Main App Controller ---

        const App = () => {
            // V√©rifier si un utilisateur existe d√©j√†
            const [hasAccount, setHasAccount] = useState(() => {
                return localStorage.getItem('medisuivi_user') !== null;
            });
            const [isLocked, setIsLocked] = useState(true);
            const [activeView, setActiveView] = useState('dashboard');
            const [darkMode, setDarkMode] = useState(() => {
                const saved = localStorage.getItem('darkMode');
                return saved ? JSON.parse(saved) : false;
            });
            const [user, setUser] = useState(() => {
                const saved = localStorage.getItem('medisuivi_user');
                return saved ? JSON.parse(saved) : null;
            });
            const [notificationsEnabled, setNotificationsEnabled] = useState(false);

            // State des donn√©es - Charger depuis localStorage
            const [medications, setMedications] = useState(() => {
                const saved = localStorage.getItem('medisuivi_medications');
                return saved ? JSON.parse(saved) : [];
            });
            const [contacts, setContacts] = useState(() => {
                const saved = localStorage.getItem('medisuivi_contacts');
                return saved ? JSON.parse(saved) : [];
            });

            // Sauvegarder automatiquement les m√©dicaments dans localStorage
            useEffect(() => {
                if (hasAccount) {
                    localStorage.setItem('medisuivi_medications', JSON.stringify(medications));
                    localStorage.setItem('medisuivi_last_save', new Date().toISOString());
                }
            }, [medications, hasAccount]);

            // Sauvegarder automatiquement les contacts dans localStorage
            useEffect(() => {
                if (hasAccount) {
                    localStorage.setItem('medisuivi_contacts', JSON.stringify(contacts));
                    localStorage.setItem('medisuivi_last_save', new Date().toISOString());
                }
            }, [contacts, hasAccount]);

            // Demander la permission pour les notifications au chargement
            useEffect(() => {
                if ('Notification' in window) {
                    if (Notification.permission === 'granted') {
                        setNotificationsEnabled(true);
                    } else if (Notification.permission !== 'denied') {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                setNotificationsEnabled(true);
                                // Notification de test
                                new Notification('MediSuivi', {
                                    body: 'Les notifications sont activ√©es ! Vous recevrez des rappels pour vos m√©dicaments.',
                                    icon: 'üíä'
                                });
                            }
                        });
                    }
                }
            }, []);

            // Effet pour le Dark Mode
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('darkMode', 'true');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('darkMode', 'false');
                }
            }, [darkMode]);

            // Fonction pour envoyer une notification
            const sendNotification = (title, body) => {
                if (notificationsEnabled && 'Notification' in window && Notification.permission === 'granted') {
                    new Notification(title, {
                        body: body,
                        icon: 'üíä',
                        badge: 'üíä',
                        tag: 'medication-reminder',
                        requireInteraction: true
                    });
                }
            };

            const handleUnlock = () => setIsLocked(false);

            const handleAccountCreated = (userProfile) => {
                setUser(userProfile);
                setHasAccount(true);
                setIsLocked(false);
            };

            const handleResetApp = () => {
                if (confirm('‚ö†Ô∏è ATTENTION : Cette action va supprimer TOUTES vos donn√©es (compte, m√©dicaments, contacts). Cette action est irr√©versible. Voulez-vous vraiment continuer ?')) {
                    // Supprimer toutes les donn√©es
                    localStorage.clear();
                    // Recharger la page
                    window.location.reload();
                }
            };

            const handleScanSave = (data) => {
                // Utiliser les heures personnalis√©es ou g√©n√©rer par d√©faut
                let timeSlots = [];
                let takenToday = {};

                if (data.frequency === "Besoin") {
                    timeSlots = ["Besoin"];
                    takenToday = {};
                } else {
                    // Utiliser les heures personnalis√©es si disponibles, sinon par d√©faut
                    if (data.customTimes && data.customTimes.length > 0) {
                        timeSlots = data.customTimes;
                    } else {
                        // Fallback: g√©n√©rer par d√©faut
                        const timesPerDay = parseInt(data.frequency) || 3;

                        if (timesPerDay === 1) {
                            timeSlots = ["08:00"];
                        } else if (timesPerDay === 2) {
                            timeSlots = ["08:00", "20:00"];
                        } else if (timesPerDay === 3) {
                            timeSlots = ["08:00", "13:00", "20:00"];
                        } else {
                            timeSlots = ["08:00", "12:00", "16:00", "20:00"];
                        }
                    }

                    timeSlots.forEach(slot => {
                        takenToday[slot] = false;
                    });
                }

                const newMed = {
                    id: Date.now(),
                    name: data.name,
                    dosage: data.dosage,
                    frequency: data.frequency,
                    duration: data.duration,
                    stock: data.totalStock,
                    totalStock: data.totalStock,
                    prescribedBy: data.prescribedBy,
                    timeSlots: timeSlots,
                    takenToday: takenToday,
                    notificationSettings: data.notificationSettings || { enabled: false }
                };

                setMedications([...medications, newMed]);

                // Planifier les notifications si activ√©es
                if (data.notificationSettings && data.notificationSettings.enabled && timeSlots[0] !== "Besoin") {
                    scheduleNotifications(newMed);
                }

                setActiveView('dashboard');
            };

            // Fonction pour planifier les notifications
            const scheduleNotifications = (medication) => {
                if (!medication.notificationSettings || !medication.notificationSettings.enabled) return;

                medication.timeSlots.forEach(timeSlot => {
                    const [hours, minutes] = timeSlot.split(':').map(Number);
                    const now = new Date();
                    const scheduledTime = new Date();
                    scheduledTime.setHours(hours, minutes, 0, 0);

                    // Si l'heure est d√©j√† pass√©e aujourd'hui, planifier pour demain
                    if (scheduledTime < now) {
                        scheduledTime.setDate(scheduledTime.getDate() + 1);
                    }

                    // Calculer le d√©lai pour le rappel
                    const reminderTime = new Date(scheduledTime);
                    reminderTime.setMinutes(reminderTime.getMinutes() - medication.notificationSettings.reminderTime);

                    const delay = reminderTime.getTime() - now.getTime();

                    if (delay > 0) {
                        setTimeout(() => {
                            sendNotification(
                                `Rappel : ${medication.name}`,
                                `N'oubliez pas de prendre ${medication.dosage} dans ${medication.notificationSettings.reminderTime} minutes !`
                            );
                        }, delay);
                    }

                    // Alerte pour dose manqu√©e (30 min apr√®s l'heure pr√©vue)
                    if (medication.notificationSettings.missedAlert) {
                        const missedAlertTime = new Date(scheduledTime);
                        missedAlertTime.setMinutes(missedAlertTime.getMinutes() + 30);
                        const missedDelay = missedAlertTime.getTime() - now.getTime();

                        if (missedDelay > 0) {
                            setTimeout(() => {
                                // V√©rifier si la dose n'a pas √©t√© prise
                                const currentMed = medications.find(m => m.id === medication.id);
                                if (currentMed && !currentMed.takenToday[timeSlot]) {
                                    sendNotification(
                                        `‚ö†Ô∏è Dose manqu√©e : ${medication.name}`,
                                        `Vous n'avez pas encore pris votre ${medication.dosage} de ${timeSlot}. Prenez-le d√®s que possible.`
                                    );
                                }
                            }, missedDelay);
                        }
                    }
                });
            };

            const toggleTakeMed = (id, timeSlot) => {
                setMedications(meds => meds.map(med => {
                    if (med.id === id) {
                        const isTaking = !med.takenToday[timeSlot];
                        
                        // Gestion du stock
                        let newStock = med.stock;
                        if (isTaking) newStock = Math.max(0, med.stock - 1);
                        else newStock = Math.min(med.totalStock, med.stock + 1);

                        // Alerte stock
                        if (newStock === 3 && isTaking) {
                            // On simulerait ici une notif toast
                            alert(`Attention : Stock faible pour ${med.name}. Pensez au renouvellement.`);
                        }

                        return {
                            ...med,
                            stock: newStock,
                            takenToday: {
                                ...med.takenToday,
                                [timeSlot]: isTaking
                            }
                        };
                    }
                    return med;
                }));
            };

            const handleDeleteMed = (id) => {
                if(confirm("Supprimer ce traitement ?")) {
                    setMedications(meds => meds.filter(m => m.id !== id));
                }
            };

            // Si pas de compte, afficher l'√©cran de bienvenue
            if (!hasAccount) {
                return <WelcomeScreen onComplete={handleAccountCreated} />;
            }

            // Si verrouill√©, afficher l'√©cran PIN
            if (isLocked) {
                return <PinScreen onUnlock={handleUnlock} userPin={user.pin} />;
            }

            return (
                <div className="max-w-md mx-auto min-h-screen bg-gray-50 dark:bg-slate-900 text-gray-900 dark:text-gray-100 relative shadow-2xl overflow-hidden">
                    
                    {/* Contenu principal Scrollable */}
                    <main className="h-screen overflow-y-auto px-5 pt-6 hide-scrollbar">
                        {activeView === 'dashboard' && (
                            <Dashboard medications={medications} onToggleTake={toggleTakeMed} user={user} />
                        )}
                        {activeView === 'scan' && (
                            <Scanner onSaveScan={handleScanSave} onBack={() => setActiveView('dashboard')} />
                        )}
                        {activeView === 'list' && (
                            <Management medications={medications} contacts={contacts} user={user} onDeleteMed={handleDeleteMed} onAddManual={() => setActiveView('manual')} />
                        )}
                        {activeView === 'manual' && (
                            <ManualAdd onSave={handleScanSave} onBack={() => setActiveView('list')} />
                        )}
                        {activeView === 'settings' && (
                            <SettingsView
                                darkMode={darkMode}
                                toggleDarkMode={() => setDarkMode(!darkMode)}
                                user={user}
                                onLogout={() => setIsLocked(true)}
                                onResetApp={handleResetApp}
                                medications={medications}
                                contacts={contacts}
                            />
                        )}
                    </main>

                    {/* Navbar Flottante (Bottom) */}
                    {activeView !== 'scan' && activeView !== 'manual' && (
                        <nav className="absolute bottom-6 left-4 right-4 bg-white/90 dark:bg-slate-800/90 backdrop-blur-lg rounded-2xl shadow-xl border border-white/20 dark:border-slate-700 p-2 flex justify-around items-center z-50">
                            <button 
                                onClick={() => setActiveView('dashboard')}
                                className={`p-3 rounded-xl transition-all ${activeView === 'dashboard' ? 'bg-medical-100 text-medical-600 dark:bg-medical-900/30 dark:text-medical-400' : 'text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700'}`}
                            >
                                <Calendar size={24} />
                            </button>
                            <button 
                                id="nav-scan"
                                onClick={() => setActiveView('scan')}
                                className={`p-4 rounded-full -mt-8 shadow-lg shadow-medical-500/30 transition-transform active:scale-95 ${activeView === 'scan' ? 'bg-gray-800 text-white' : 'bg-medical-500 text-white'}`}
                            >
                                <Camera size={28} />
                            </button>
                            <button 
                                onClick={() => setActiveView('list')}
                                className={`p-3 rounded-xl transition-all ${activeView === 'list' ? 'bg-medical-100 text-medical-600 dark:bg-medical-900/30 dark:text-medical-400' : 'text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700'}`}
                            >
                                <Pill size={24} />
                            </button>
                            <button 
                                onClick={() => setActiveView('settings')}
                                className={`p-3 rounded-xl transition-all ${activeView === 'settings' ? 'bg-medical-100 text-medical-600 dark:bg-medical-900/30 dark:text-medical-400' : 'text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700'}`}
                            >
                                <Settings size={24} />
                            </button>
                        </nav>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

    <!-- Enregistrement du Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker enregistr√©:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ùå Erreur Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>